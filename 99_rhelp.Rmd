# Справочник по манипуляциями с данными

## План

+ проекты
+ импорт - комманды
  + rio::import
  + read.table, read_xslx, read_csv ...
+ манипуляции с данными (все с реальными примерами!)
  + проверка типов данных
  + десятичные разделители
  + ошибки, строковые преобразования
  + выбросы - ошибки непрерывных переменных => график и исправить
  + категориальные переменные - уникальные значения и опечатки, регистры
  + пропущенные данные
+ преобразования данных и пайплайны
  + типы пайплайнов
    + 100 %>% sqrt() %>% log()
    + x = 100 %>% sqrt() %>% log()
    + x <- 100 %>% sqrt() %>% log()
    + 100 %>% sqrt() %>% log() -> x
  + =/<-/->/%>%/%<>%/%$%, select, rename, mutate, filter, group_by, summarise, pull/pluck, stack, rerun, extrac_grid, \*join, str\*, regex, rstatix, naniar, tidy(...), augment, {.}
  + pivot*
  + nest/unnest/map*/.x
  + ggplot

## Папки и проекты

Для удобства работы над каким-то проектом (например, обучение работы в `R` на наших занятиях) удобно завести под это специальную папку и держать в ней все файлы. 

### Работа с папками

Чтобы `R` знал, в какой папке искать файлы, можно один раз задать базовую папку командой `setwd("C:/Path/to/my folder")`, либо при каждом обращении к файлу указывать полный путь к файлу, например `import("C:/Path/to/my folder/my file.xlsx")` (внимание, даже в Windows используем прямой слэш - "/"!). Однако это не очень удобно, изменение имени папки черевато ошибками. Поэтому у счастливых пользователей `RStudio` есть возможность облегчить себе жизнь путем использованием проектов. 

### Работа с проектами

Для создания нового проекта нужно в меню открыть `File > New Project > New Directory > New Project`, после чего нужно будет задать имя корневой папки для проектов (например, `C:/Users/ThatsMe/R/`) и имя папки для текущего проекта (например, `BiochemStatsCourse`), после чего нажать `Create Project`. После этого данная папка будет считаться базовой и можно будет дальнейшие файлы создавать в ней самой или ее подпапках. Если вы кинули файл `my file.xls` в подпапку `data`, то его можно будет прочитать командой `import("data/my file.xlsx")` (уже не нужно указывать полный путь к папке, который будет `C:/Users/ThatsMe/R/BiochemStatsCourse/data/my file.xlsx`).

Более подробно об этом можно почитать [здесь](https://bookdown.org/ndphillips/YaRrr/projects-in-rstudio.html), [здесь](https://r4ds.had.co.nz/workflow-projects.html) или [здесь](https://www.tidyverse.org/blog/2017/12/workflow-vs-script/).

## Импорт

Данные, которые мы можем анализировать могут быть созданы в какой угодно программе (Excel, другие статистические программы, софт различных приборов и т.д.). Мы даже можем анализировать данные Web-страниц.

Самый частый в моей практике случай - использование файлов, созданных в Excel или экспортированных в этот формат. Наилучшим образом подходят для импорта в `R` форматы CSV и XSLX, однако можно научить `R` читать практически любой формат (кроме зашифрованных производителем). 

Для примера скачаем тестовый файл по [ссылке](https://github.com/lapotok/biochemstat_book/blob/master/data/iris.xlsx?raw=true) и сохраним его вручную в нужную папку. 

 > Однако это можно сделать и с помощью `R`. Для этого сначала сгенерируем имя временного файла и сохраним его в переменную tmp (или же вы можете прописать путь к папке и имя файла, если далее хотите с ним иметь дело), затем сохраним в него скачанный файл. После завершения работы скрипта временный файл будет удален, а если Вы сами указали путь и имя файла, тогда он останется.
> ```{r eval = F}
# запишем в переменную имя файла
filename = "data/iris.xlsx"
# скачиваем файл по ссылке
download.file("https://github.com/lapotok/biochemstat_book/blob/master/data/iris.xlsx?raw=true", filename)
```

Теперь этот файл можем открыть. Форматов бывает много, однако одна из наиболее продвинутых библиотек `rio` позволяет открывать практически любые распространенные форматы.

```{r cache = T}
library(rio)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(magrittr))
my_iris = import("data/iris.xlsx")
my_iris %>% str()
my_iris$Species %>% unique()
```

Видим, что файл открылся правильно, т.к.

+ правильное число строк и столбцов
+ числовые переменные действительно имеют тип `num` (а не текстовый тип `chr` и не фактор `factor`)
+ в списке видов нет ничего лишнего, никаких ошибочно написанных

Теперь для разнообразия откроем файл с ошибками.

```{r cache = T}
#download.file("https://github.com/lapotok/biochemstat_book/blob/master/data/bad_data_example.xlsx?raw=true", "data/bad_data_example.xlsx") 
bad = import("data/bad_data_example.xlsx")
bad %>% str() # смотрим на типы данных разных переменных
bad$Species %>% unique() # все ли названия правильные? нет ничего лишнего?
bad$"Пол" %>% unique() # должно быть 2 пола или пропуск в данных, так ли это?
```

Какие могут быть ошибки в данных? В файле, который мы рассматриваем в качестве антипримера есть следующие ошибки

* неправильный десятичный разделитель в `Weight` и как следствие вся переменная определяется как строковая, а не численная
* пропущенные данные, абы как названные (надо составить указания для `R` в формате регулярных выражений, что заменять на `NA` без кавычек - специальное обозначение для пропущенных данных)
* русскоязычные названия переменных и названия с пробелами, что может вызывать неудобство в работе, например необходимость их закавычивать при обращении к ним (```bad$`Num ticks` ```)
* в колонке "Пол" буквы разного регистра обозначают одно и то же

Какие-то из ошибок можно исправить уже на этапе подготовки данных (см. [рекомендации](http://www.sthda.com/english/wiki/best-practices-in-preparing-data-files-for-importing-into-r)). Идеальная форма представления данных воплощается в концепте ["tidy data"](https://vita.had.co.nz/papers/tidy-data.pdf).

Учимся исправлять ошибки, которые мы уже научились находить. 

```{r cache = T}
library(naniar)
good = 
  bad %>%
  mutate(Weight = str_replace(Weight, ",", ".")) %>% # исправляем ошибку: заменяем , на .
  mutate(Weight = as.numeric(Weight)) %>% # теперь изменяем тип переменной на числовой
  rename(Gender=`Пол`, Num_ticks=`Num ticks`) %>% # переименовываем переменные, чтобы дальше было удобнее
  replace_with_na_all(~ str_detect(.x, regex("(^na$)|(.*hz.*)|(.*\\?.*)", ignore_case = T))) %>% # заменяем на NA (см. дальше)
  mutate(Gender = toupper(Gender)) # для унификации заменяем все буквы на большие

# а теперь как?
good %>% str()
good$Species %>% unique()
good$Gender %>% unique()
```

Здесь стоит отдельно остановиться на выражении `regex("(^na$)|(.*hz.*)|(.*\\?.*)", ignore_case = T)`. Речь идет об использовании регулярных выражений. Это способ указывать критерий для поиска или замен в строках. Простейший житейский пример регулярного выражения (правда, синтаксис там не очень правильный, зато понятный) - это когда мы выбираем файлы Excel выражением `*.xls(x)`. 

Здесь я приведу один пример работы с ними: проверяем адреса электронной почты на правильность (это простенький пример, не претендующий на абсолютную правильность).

```{r cache = T}
# поиск по паттерну
mails = c("good@mail1.ru",
          "good@mail2.ru",
          "bad@mail@ru",
          "another*bad@mail.ru") # список адресов

mail_regex = "^[A-Za-z0-9.+_-]+@[A-Za-z0-9.+_-]+\\.[A-Za-z0-9.+_-]{2,}$" # регулярное выражение

str_detect(mails, mail_regex) # проверяем адреса на соответствие выражению
```

Разберем по частям

+ `^` в начале обозначает, что мы ищем с начала строки включительно, а `$` - что искомый элемент заканчивается концом строки; т.е. в итоге мы хотим чтобы строка полностью соответствовала шаблону, а не ее какая-то часть;
+ `[A-Za-z0-9.+_-]` - это любой из символов в скобках, причем все большие буквы задаются диапазоном `A-Z`; аналогично задаются все маленькие и все цифры;
+ `[A-Za-z0-9.+_-]+` - это вышеупомянутые символы, которые повторяются 1 и более раз (это указывается символом `+`; если может быть 0 и более раз, то используем символ `*`; чтобы в явном виде указать диапазон используем синтаксис `{min,max}`);
+ `.` вне скобок обозначает любой символ, поэтому для обозначения точки нужно использовать сочетание `\\.`.

Здесь я не буду подробнее останавливаться на регулярных выражениях, Вы можете подробнее прочитать про это по ссылкам далее [[1](https://stringr.tidyverse.org/articles/regular-expressions.html), [2](https://github.com/rstudio/cheatsheets/blob/master/regex.pdf), [3](https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html)].
